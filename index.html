<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è°æ˜¯å§åº• - ç³–æœæ´¾å¯¹</title>
    <style>
        :root {
            --bg-color: #FDF6F0; /* å¥¶æ²¹åº•è‰² */
            --primary: #FFB7B2; /* ç³–æœç²‰ */
            --secondary: #B5EAD7; /* è–„è·ç»¿ */
            --accent: #C7CEEA; /* é¦™èŠ‹ç´« */
            --text: #6D6D6D; /* æŸ”å’Œç° */
            --card-bg: #FFFFFF;
            --danger: #FF9AA2;
            --shadow: 0 8px 24px rgba(149, 157, 165, 0.2);
            --radius: 20px;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é€šç”¨ç»„ä»¶ */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }
        .screen.active { display: flex; }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 183, 178, 0.4);
            cursor: pointer;
            transition: transform 0.1s;
            width: 100%;
            margin-top: 10px;
        }
        .btn:active { transform: scale(0.95); }
        .btn.secondary { background: var(--secondary); color: #555; }
        .btn.danger { background: var(--danger); }
        .btn.small { padding: 8px 16px; font-size: 0.9rem; width: auto; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            text-align: center;
        }

        h1, h2, h3 { color: #555; margin: 0 0 15px 0; }
        .center-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* é¦–é¡µ */
        .logo { font-size: 3rem; margin-bottom: 20px; text-shadow: 2px 2px 0px var(--secondary); }
        .input-group { margin-bottom: 20px; width: 100%; }
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--accent);
            border-radius: 15px;
            font-size: 1.2rem;
            text-align: center;
            outline: none;
            color: var(--text);
        }

        /* è§„åˆ™å¼¹çª— */
        #ruleModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; width: 85%; max-height: 80%; overflow-y: auto;
            border-radius: var(--radius); padding: 25px;
        }
        .rule-item { text-align: left; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.5; }
        .rule-tag { display: inline-block; background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; margin-right: 5px; font-size: 0.8rem;}

        /* æŠ½è¯ç•Œé¢ */
        .flip-card {
            width: 260px; height: 360px; perspective: 1000px; margin: 0 auto;
        }
        .flip-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flip-inner.flipped { transform: rotateY(180deg); }
        .flip-front, .flip-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: var(--radius);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: var(--shadow);
        }
        .flip-front { background: var(--accent); color: white; cursor: pointer; }
        .flip-back { background: white; transform: rotateY(180deg); color: var(--danger); border: 4px solid var(--accent); }
        .word-reveal { font-size: 2.5rem; font-weight: bold; margin: 20px 0; }

        /* æ¸¸æˆè¿›è¡Œä¸­ */
        .timer-bar {
            background: white; padding: 15px; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .big-timer { font-size: 1.5rem; font-weight: bold; color: var(--danger); }
        
        .player-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            margin-bottom: 20px;
        }
        .player-avatar {
            aspect-ratio: 1; background: white; border-radius: 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 0.8rem; border: 2px solid transparent; position: relative;
            transition: 0.3s;
        }
        .player-avatar.active { border-color: var(--primary); background: #FFF0F5; transform: scale(1.05); }
        .player-avatar.out { opacity: 0.4; filter: grayscale(1); }
        .player-avatar .num { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
        .status-badge { 
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; 
            border-radius: 50%; background: #ddd; font-size: 10px; line-height: 20px; color: white;
        }

        .speaking-area {
            background: white; border-radius: var(--radius); padding: 30px 20px;
            text-align: center; box-shadow: var(--shadow); margin-bottom: 20px;
        }
        .speaking-timer { font-size: 3rem; color: var(--secondary); font-weight: 800; margin: 10px 0; }

        /* æŠ•ç¥¨ç•Œé¢ */
        .vote-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .vote-btn {
            background: white; border: 2px solid var(--accent); padding: 20px;
            border-radius: 15px; font-size: 1.2rem; color: var(--text);
        }
        .vote-btn.selected { background: var(--accent); color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div class="center-content">
            <div class="logo">ğŸ¬<br>è°æ˜¯å§åº•</div>
            <div style="font-size: 0.9rem; margin-bottom: 30px; opacity: 0.7;">ç³–æœæ´¾å¯¹ç‰ˆ Â· 8äººå±€</div>
            
            <div class="card" style="width: 100%;">
                <div class="input-group">
                    <input type="number" id="roomCode" placeholder="è¾“å…¥æˆ¿é—´å· (å¦‚: 666)" value="8888">
                </div>
                <button class="btn" onclick="joinRoom()">è¿›å…¥æˆ¿é—´</button>
                <button class="btn secondary" onclick="toggleRules()">ğŸ“ æ¸¸æˆè§„åˆ™</button>
            </div>
        </div>
    </div>

    <div id="screen-role" class="screen">
        <h2 style="text-align: center;">æŠ½å–è¯æ±‡</h2>
        <div style="text-align: center; margin-bottom: 20px; color: #888;">è¯· <span id="checkPlayerNum" style="color:var(--primary); font-weight:bold;">1</span> å·ç©å®¶æŸ¥çœ‹</div>
        
        <div class="center-content">
            <div class="flip-card" onclick="flipCard()">
                <div class="flip-inner" id="cardInner">
                    <div class="flip-front">
                        <div style="font-size: 3rem;">ğŸƒ</div>
                        <div style="margin-top:20px;">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹</div>
                    </div>
                    <div class="flip-back">
                        <div>ä½ çš„è¯è¯­æ˜¯</div>
                        <div class="word-reveal" id="wordText">???</div>
                        <div style="font-size: 0.8rem; color:#999;">è¯·è®°ä½è¯è¯­å¹¶ç‚¹å‡»éšè—</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn" id="nextRoleBtn" onclick="nextRole()" style="display:none;">è®°ä½äº†ï¼Œä¼ ç»™ä¸‹ä¸€ä½</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="timer-bar">
            <div>æ€»æ—¶é•¿</div>
            <div class="big-timer" id="globalTimer">10:00</div>
        </div>

        <div class="player-grid" id="playerStatusGrid">
            </div>

        <div class="speaking-area">
            <h3 id="currentSpeakerName">ç­‰å¾…å¼€å§‹...</h3>
            <div style="font-size: 0.9rem; color: #999;">å‘è¨€å€’è®¡æ—¶</div>
            <div class="speaking-timer" id="turnTimer">60</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn secondary small" onclick="skipTurn()">â­ï¸ è·³è¿‡</button>
                <button class="btn small" onclick="finishTurn()">âœ… å®Œæˆ</button>
            </div>
        </div>

        <button class="btn danger" onclick="startVote()">ğŸ—³ï¸ å‘èµ·æŠ•ç¥¨</button>
    </div>

    <div id="screen-vote" class="screen">
        <h2>è¯·æŠ•ç¥¨å¤„å†³å§åº•</h2>
        <p style="text-align: center; color: #888;">å¾—ç¥¨æœ€å¤šè€…å°†è¢«æ·˜æ±°</p>
        <div class="center-content">
            <div class="vote-grid" id="voteGrid">
                </div>
        </div>
        <button class="btn" onclick="confirmVote()">ç¡®è®¤æŠ•ç¥¨ç»“æœ</button>
    </div>

    <div id="screen-result" class="screen">
        <div class="center-content">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ†</div>
            <h1 id="winnerTitle">å¹³æ°‘èƒœåˆ©!</h1>
            <div class="card" style="width: 100%;">
                <p><strong>å§åº•è¯ï¼š</strong> <span id="resSpyWord" style="color:var(--danger)"></span></p>
                <p><strong>å¹³æ°‘è¯ï¼š</strong> <span id="resCivWord" style="color:var(--secondary)"></span></p>
                <p><strong>å§åº•æ˜¯ï¼š</strong> <span id="resSpyNum"></span> å·</p>
            </div>
            <button class="btn" onclick="resetGame()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <div id="ruleModal" onclick="toggleRules()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="text-align: center; color: var(--primary);">ğŸ“œ æ¸¸æˆè§„åˆ™</h2>
            <div class="rule-item">
                <span class="rule-tag">é…ç½®</span> 8äººå±€ï¼š7å¹³æ°‘ vs 1å§åº•ã€‚
            </div>
            <div class="rule-item">
                <span class="rule-tag">è¯è¯­</span> å¤§éƒ¨åˆ†äººæ‹¿åˆ°ç›¸åŒè¯è¯­ï¼Œ1äººæ‹¿åˆ°ç›¸å…³ä½†ä¸åŒçš„è¯è¯­ã€‚äº’ç›¸ä¸çŸ¥é“èº«ä»½ã€‚
            </div>
            <div class="rule-item">
                <span class="rule-tag">æè¿°</span> æ¯äººä¸€å¥è¯æè¿°è¯è¯­ã€‚ä¸èƒ½å¤ªæ˜æ˜¾ï¼ˆé˜²å§åº•çŒœåˆ°ï¼‰ï¼Œä¹Ÿä¸èƒ½å¤ªæ¨¡ç³Šï¼ˆé˜²è¢«å½“æˆå§åº•ï¼‰ã€‚
            </div>
            <div class="rule-item">
                <span class="rule-tag">èƒœåˆ©</span> 
                <br>â€¢ å§åº•æ’‘åˆ°åœºä¸Šå‰©3äºº -> å§åº•èƒœã€‚
                <br>â€¢ å§åº•è¢«æŠ•ç¥¨å‡ºå±€ -> å¹³æ°‘èƒœã€‚
            </div>
            <button class="btn small" onclick="toggleRules()">æˆ‘æ˜ç™½äº†</button>
        </div>
    </div>

    <script>
        // --- è¯åº“ (åŸºäºå›¾äºŒ) ---
        const wordPairs = [
            ['é¥ºå­', 'é¦„é¥¨'], ['åŒ…å­', 'çƒ§å–'], ['é¥¼å¹²', 'è›‹ç³•'], ['è±†æµ†', 'ç‰›å¥¶'],
            ['è‡ªè¡Œè½¦', 'ç”µåŠ¨è½¦'], ['ç«è½¦', 'åœ°é“'], ['å¥”é©°', 'å®é©¬'],
            ['ç‹®å­', 'è€è™'], ['çŒ«', 'ç‹—'], ['ä¼é¹…', 'åŒ—æç†Š'],
            ['ç«ç‘°', 'éƒé‡‘é¦™'], ['ç™¾åˆ', 'èŒ‰è‰'], ['æ¡ƒèŠ±', 'æ¨±èŠ±'],
            ['è¡¬è¡«', 'Tæ¤'], ['ç¾½ç»’æœ', 'æ£‰è¢„'], ['å›´å·¾', 'æ‰‹å¥—'],
            ['ç”„å¬›ä¼ ', 'å¦‚æ‡¿ä¼ '], ['é’¢é“ä¾ ', 'èœ˜è››ä¾ '], ['å“ˆåˆ©æ³¢ç‰¹', 'æŒ‡ç¯ç‹'],
            ['å¾®ä¿¡', 'QQ'], ['æ‰‹æœº', 'å¹³æ¿'], ['å¤–å–', 'å¿«é€’'],
            ['ç‹è€…è£è€€', 'è‹±é›„è”ç›Ÿ'], ['åŸç¥', 'å´©åæ˜Ÿç©¹é“é“']
        ];

        // --- æ¸¸æˆçŠ¶æ€ ---
        let gameState = {
            players: [], // {id: 1, role: 'civilian', word: '', status: 'alive'}
            currentTurnIndex: 0,
            spyIndex: -1,
            civilianWord: '',
            spyWord: '',
            globalTimeLeft: 600, // 10åˆ†é’Ÿ
            turnTimeLeft: 60,
            globalTimerId: null,
            turnTimerId: null,
            checkingRoleIndex: 0
        };

        // --- è·¯ç”±æ§åˆ¶ ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toggleRules() {
            const modal = document.getElementById('ruleModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        // --- æ¸¸æˆåˆå§‹åŒ–é€»è¾‘ ---
        function joinRoom() {
            // ç®€å•æ¨¡æ‹Ÿè¿›å…¥æˆ¿é—´ï¼Œå®é™…è”æœºéœ€è¦WebSocket
            initGameData();
            showScreen('screen-role');
            updateCheckRoleUI();
        }

        function initGameData() {
            // 1. é€‰è¯
            const pair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
            // éšæœºå†³å®šè°æ˜¯å¹³æ°‘è¯
            const swap = Math.random() > 0.5;
            gameState.civilianWord = swap ? pair[0] : pair[1];
            gameState.spyWord = swap ? pair[1] : pair[0];
            
            // 2. åˆ†é…èº«ä»½ (1å§åº• 7å¹³æ°‘)
            gameState.players = Array(8).fill(null).map((_, i) => ({
                id: i + 1,
                role: 'civilian',
                word: gameState.civilianWord,
                status: 'alive'
            }));
            
            gameState.spyIndex = Math.floor(Math.random() * 8);
            gameState.players[gameState.spyIndex].role = 'spy';
            gameState.players[gameState.spyIndex].word = gameState.spyWord;

            // é‡ç½®è®¡æ•°å™¨
            gameState.checkingRoleIndex = 0;
            gameState.globalTimeLeft = 600;
        }

        // --- èº«ä»½æŸ¥çœ‹é€»è¾‘ ---
        let isCardFlipped = false;
        
        function updateCheckRoleUI() {
            document.getElementById('checkPlayerNum').innerText = gameState.checkingRoleIndex + 1;
            const cardInner = document.getElementById('cardInner');
            cardInner.classList.remove('flipped');
            isCardFlipped = false;
            document.getElementById('nextRoleBtn').style.display = 'none';
        }

        function flipCard() {
            if (isCardFlipped) return; // å·²ç»ç¿»å¼€äº†
            
            const cardInner = document.getElementById('cardInner');
            const wordText = document.getElementById('wordText');
            
            wordText.innerText = gameState.players[gameState.checkingRoleIndex].word;
            cardInner.classList.add('flipped');
            isCardFlipped = true;
            
            // æ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('nextRoleBtn').style.display = 'block';
        }

        function nextRole() {
            gameState.checkingRoleIndex++;
            if (gameState.checkingRoleIndex >= 8) {
                startGamePlay();
            } else {
                updateCheckRoleUI();
            }
        }

        // --- æ¸¸æˆä¸»å¾ªç¯ ---
        function startGamePlay() {
            showScreen('screen-game');
            renderPlayers();
            startGlobalTimer();
            startTurn(0);
        }

        function renderPlayers() {
            const grid = document.getElementById('playerStatusGrid');
            grid.innerHTML = '';
            gameState.players.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = `player-avatar ${p.status === 'out' ? 'out' : ''}`;
                if(index === gameState.currentTurnIndex && p.status === 'alive') div.classList.add('active');
                
                div.innerHTML = `
                    <div class="num">${p.id}</div>
                    <div>${p.status === 'alive' ? 'ğŸ˜Š' : 'ğŸ’€'}</div>
                `;
                grid.appendChild(div);
            });
        }

        // è®¡æ—¶å™¨é€»è¾‘
        function startGlobalTimer() {
            if (gameState.globalTimerId) clearInterval(gameState.globalTimerId);
            gameState.globalTimerId = setInterval(() => {
                gameState.globalTimeLeft--;
                const m = Math.floor(gameState.globalTimeLeft / 60).toString().padStart(2, '0');
                const s = (gameState.globalTimeLeft % 60).toString().padStart(2, '0');
                document.getElementById('globalTimer').innerText = `${m}:${s}`;
                if(gameState.globalTimeLeft <= 0) {
                    alert("æ—¶é—´åˆ°ï¼æ¸¸æˆç»“æŸ");
                    clearInterval(gameState.globalTimerId);
                }
            }, 1000);
        }

        function startTurn(playerIndex) {
            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ´»ç€çš„äºº
            let found = false;
            let checkIndex = playerIndex;
            let loopCount = 0;
            
            // ç®€å•çš„è½®æµé€»è¾‘ï¼Œå¦‚æœæ‰€æœ‰äººéƒ½è¯´è¿‡ä¸€è½®ï¼Œè¿™é‡Œç®€åŒ–ä¸ºä¸€ç›´å¾ªç¯ï¼Œç”±ç©å®¶æ§åˆ¶ä½•æ—¶æŠ•ç¥¨
            while(loopCount < 8) {
                checkIndex = checkIndex % 8;
                if(gameState.players[checkIndex].status === 'alive') {
                    gameState.currentTurnIndex = checkIndex;
                    found = true;
                    break;
                }
                checkIndex++;
                loopCount++;
            }

            renderPlayers();
            
            const player = gameState.players[gameState.currentTurnIndex];
            document.getElementById('currentSpeakerName').innerText = `ğŸ¤ ç©å®¶ ${player.id} å‘è¨€ä¸­`;
            
            // é‡ç½®å•äººå€’è®¡æ—¶
            clearInterval(gameState.turnTimerId);
            gameState.turnTimeLeft = 60; 
            document.getElementById('turnTimer').innerText = 60;
            
            gameState.turnTimerId = setInterval(() => {
                gameState.turnTimeLeft--;
                document.getElementById('turnTimer').innerText = gameState.turnTimeLeft;
                if(gameState.turnTimeLeft <= 0) {
                    finishTurn(); // è¶…æ—¶è‡ªåŠ¨ä¸‹ä¸€ä¸ª
                }
            }, 1000);
        }

        function finishTurn() {
            startTurn(gameState.currentTurnIndex + 1);
        }
        
        function skipTurn() {
            finishTurn();
        }

        // --- æŠ•ç¥¨é€»è¾‘ ---
        function startVote() {
            clearInterval(gameState.turnTimerId); // æš‚åœå‘è¨€è®¡æ—¶
            showScreen('screen-vote');
            const grid = document.getElementById('voteGrid');
            grid.innerHTML = '';
            
            gameState.players.forEach(p => {
                if(p.status === 'alive') {
                    const btn = document.createElement('button');
                    btn.className = 'vote-btn';
                    btn.innerText = `ç©å®¶ ${p.id}`;
                    btn.onclick = () => {
                        // æ¨¡æ‹Ÿç‚¹å‡»æ•ˆæœ
                        document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        // è®°å½•é€‰ä¸­IDï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦å¤šäººæŠ•ç¥¨ç»Ÿè®¡ï¼Œè¿™é‡Œæ¨¡æ‹Ÿæ³•å®˜ç›´æ¥é€‰æ­»è€…
                        btn.dataset.id = p.id;
                    };
                    grid.appendChild(btn);
                }
            });
        }

        function confirmVote() {
            const selected = document.querySelector('.vote-btn.selected');
            if(!selected) return alert("è¯·é€‰æ‹©ä¸€åç©å®¶æ·˜æ±°");
            
            const outId = parseInt(selected.dataset.id);
            const outIndex = gameState.players.findIndex(p => p.id === outId);
            
            gameState.players[outIndex].status = 'out';
            
            checkWinCondition(outIndex);
        }

        function checkWinCondition(lastOutIndex) {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            const spy = gameState.players[gameState.spyIndex];
            
            // 1. å§åº•å‡ºå±€ -> å¹³æ°‘èƒœ
            if (lastOutIndex === gameState.spyIndex) {
                showResult('civilian');
                return;
            }
            
            // 2. ä»…å‰©3äººä¸”å§åº•åœ¨åœº -> å§åº•èƒœ
            if (alivePlayers.length <= 3 && spy.status === 'alive') {
                showResult('spy');
                return;
            }
            
            // æ¸¸æˆç»§ç»­
            showScreen('screen-game');
            renderPlayers();
            // ä»è¢«æ·˜æ±°è€…çš„ä¸‹ä¸€ä½å¼€å§‹
          startTurn(lastOutIndex + 1);
        }

        function showResult(winner) {
            clearInterval(gameState.globalTimerId);
            clearInterval(gameState.turnTimerId);
            showScreen('screen-result');
            
            const isCivWin = winner === 'civilian';
            document.getElementById('winnerTitle').innerText = isCivWin ? 'ğŸ‰ å¹³æ°‘èƒœåˆ©!' : 'ğŸ˜ˆ å§åº•èƒœåˆ©!';
            document.getElementById('winnerTitle').style.color = isCivWin ? 'var(--secondary)' : 'var(--danger)';
            
            document.getElementById('resCivWord').innerText = gameState.civilianWord;
            document.getElementById('resSpyWord').innerText = gameState.spyWord;
            document.getElementById('resSpyNum').innerText = gameState.players[gameState.spyIndex].id;
        }

        function resetGame() {
            showScreen('screen-home');
        }
    </script>
</body>
</html>